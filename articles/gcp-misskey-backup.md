---
title: "GCPã§ Misskey ã® PostgresDB ã¨ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["gcp", "misskey"]
published: true
---

# ã¯ã˜ã‚ã«

https://zenn.dev/ganariya/articles/gcp-misskey-instance

https://misskey.ganyariya.net/

GCP ã® Google Compute Engine ã§ Misskey ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ã—ã‹ã—ã€ä¸Šè¨˜ã§æ§‹ç¯‰ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å»ºã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

- e2-micro (ç„¡æ–™æ ) ã¨ã„ã†å¼±ã„ã‚¹ãƒšãƒƒã‚¯
- postgre ã¯ç›´æ¥ VM ä¸Šã§å‹•ã„ã¦ã„ã‚‹
  - redis ã‚‚åŒæ§˜ã« VM ä¸Šã§å‹•ã„ã¦ã„ã‚‹
- ç”»åƒã‚„éŸ³å£°ãªã©ã®ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã¯ VM ä¸Šã® files ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç›´æ¥ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
  - VM ä¸Šã® misskey ãŒç›´æ¥é…ä¿¡ã—ã¦ã„ã‚‹

VM ä¸Šã«ç›´æ¥ postgreSQL ã‚„ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¹—ã£ã¦ã„ã‚‹ãŸã‚ã€ VM ã‚’æ¶ˆã™ã¨ãƒ‡ãƒ¼ã‚¿ãŒã™ã¹ã¦æ¶ˆãˆã¾ã™ã€‚

https://hide.ac/articles/E2Ea3cauk

ãã®ãŸã‚ã€ä»Šå›ã¯ GCP ä¸Šã«ã“ã‚Œã‚‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—ã—ãŸãŸã‚ã€ãã®å†…å®¹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

# postgre ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

https://hide.ac/articles/E2Ea3cauk

ä¸Šè¨˜ã‚’å‚è€ƒã«å®Ÿè¡Œã—ã¾ã™ã€‚

## postgre dump

pg_dumpall ã§ dump ã—ã¾ã™ã€‚

```bash
sudo -u postgres pg_dumpall | gzip -c > misskey.gz
```

## gsutil

gsutil ã§ GCS ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```bash
gsutil cp misskey.gz gs://your-storage/misskey.gz
```

ã“ã®ã¨ãã€ IAM ãªã‚‰ã³ã« VM ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚¹ã‚³ãƒ¼ãƒ—ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªãŒå¿…è¦ã§ã™ã€‚

### IAM

VM ã«ç´ä»˜ã„ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ GCS ã®ãƒ­ãƒ¼ãƒ«/æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
è©²å½“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« `Storage ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆè€…` ãƒ­ãƒ¼ãƒ«ãªã©ã‚’ä»˜ä¸ã—ã€ Cloud Storage ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

```bash
# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®è¡¨ç¤ºï¼ˆã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä»˜ä¸ã™ã‚Œã°ã„ã„ã‹ã®ç¢ºèªï¼‰
gcloud auth list
```

### ã‚¢ã‚¯ã‚»ã‚¹ã‚¹ã‚³ãƒ¼ãƒ—

![](https://storage.googleapis.com/zenn-user-upload/9db5ffd3d790-20230325.png)

https://blog.g-gen.co.jp/entry/vm-api-iam

è‡ªåˆ†ã®å ´åˆã€ IAM ã®è¨­å®šã¯å•é¡Œãªã‹ã£ãŸã®ã§ã™ãŒã€ã‚¢ã‚¯ã‚»ã‚¹ã‚¹ã‚³ãƒ¼ãƒ—ã®è¨­å®šãŒè¶³ã‚Šã¦ãŠã‚‰ãšã†ã¾ãã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
VM ã‹ã‚‰ GCS ã® API ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚¹ã‚³ãƒ¼ãƒ—ã« `ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ èª­ã¿å–ã‚Š / æ›¸ãè¾¼ã¿` ã‚’è¨­å®šã—ã¾ã—ãŸã€‚

ï¼ˆæœ¬æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚¹ã‚³ãƒ¼ãƒ—ã¯ã™ã¹ã¦ã® API ã‚’è¨±å¯ã—ã€ã‹ã¤ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æœ€å°ã®æ¨©é™ã®ã¿ä¸ãˆã‚‹ã®ãŒã‚ˆã„ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚ï¼‰

## cron è¨­å®š

```bash
sudo mkdir /var/backup
sudo chmod 777 /var/backup

sudo vi /etc/cron.d/pgbuckup

# pgbuckup æ¯é€±ä¸€å›ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
SHELL=/bin/bash
0 0 * * 1 postgres pg_dumpall | gzip -c > /var/backup/misskey.gz
0 1 * * 1 ganyariya gsutil cp /var/backup/misskey.gz gs://your-storage/misskey.gz

# æœ‰åŠ¹åŒ–
sudo chmod 644 /etc/cron.d/pgbuckup
sudo systemctl restart cron
```

# ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«

## GCS ã®è¨­å®š

![](https://storage.googleapis.com/zenn-user-upload/031c1b6309d2-20230325.png)

misskey ã‹ã‚‰ Cloud Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã€ `ç›¸äº’é‹ç”¨æ€§` ã®ãƒšãƒ¼ã‚¸ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ HMAC èªè¨¼ã‚’è¨­å®šã—ã¾ã™ã€‚
ä»»æ„ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆä¾‹: misskey-service-account@your-project.iam.gserviceaccount.comï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚
ã™ã‚‹ã¨ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ãŒç™ºè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã®ã¡ã»ã© misskey ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã§è¨­å®šã—ã¾ã™ã€‚

ç¶šã„ã¦ã€ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦ã€ IAM ãƒ­ãƒ¼ãƒ« `Storage ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆè€…` ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚
misskey ãŒç”»åƒã‚’ Cloud Storage ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/1c19dea5c1ac-20230325.png)

## Misskey ã®è¨­å®š

https://your-misskey/admin/object-storage

misskey ã® object-storage ã‚’é–‹ã„ã¦ã€ GCS ã«ãƒ¡ãƒ‡ã‚£ã‚¢ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/2b797b804c3d-20230325.png)

# æœ€å¾Œã«

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã§ããŸã®ã§ã€ã²ã¨ã¾ãš VM ãŒè½ã¡ã¦ã‚‚å®‰å¿ƒã§ã™ã­ã€‚
ï¼ˆãŸã ã€å¾©æ—§ä½œæ¥­ã¯å¤§å¤‰ãã†ã ãªã...ï¼‰

æœ¬å½“ã¯ Cloud SQL ã‚„ MemoryStore, GKE ãªã©ã¸ã®ç§»è¡Œã‚‚ã—ãŸã»ã†ãŒã‚ˆã„ã®ã§ã—ã‚‡ã†ãŒã€ãŠé‡‘ãŒã‹ã‹ã£ã¦ã—ã¾ã†ã®ã§ã—ã°ã‚‰ãã¯ e2-micro ã‚ªãƒ³ãƒªãƒ¼ã§é‹ç”¨ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
